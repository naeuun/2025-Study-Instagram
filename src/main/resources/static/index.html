<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Instagram API í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: auto;
        }

        .container {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        h2 {
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        input,
        textarea {
            width: calc(100% - 22px);
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            padding: 10px 15px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }

        button:hover {
            background-color: #0056b3;
        }

        .update-btn {
            background-color: #28a745;
        }

        .update-btn:hover {
            background-color: #218838;
        }

        .delete-btn {
            background-color: #dc3545;
        }

        .delete-btn:hover {
            background-color: #c82333;
        }

        .like-btn {
            padding: 5px 10px;
            background-color: #ff69b4;
        }

        .liked {
            background-color: #ff1493;
        }

        .like-btn:hover {
            background-color: #e35a9e;
        }

        #jwt-token-display {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            word-wrap: break-word;
            margin-top: 10px;
        }

        .hidden {
            display: none;
        }

        #posts-list div.post-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }

        #posts-list div.post-item:last-child {
            border-bottom: none;
        }
    </style>
</head>

<body>

<h1>Instagram ë°±ì—”ë“œ API í…ŒìŠ¤íŠ¸ í˜ì´ì§€</h1>

<div class="container">
    <h2>1. íšŒì›ê°€ì…</h2>
    <input type="text" id="signup-username" placeholder="ì‚¬ìš©ì ì´ë¦„">
    <input type="password" id="signup-password" placeholder="ë¹„ë°€ë²ˆí˜¸">
    <input type="email" id="signup-email" placeholder="ì´ë©”ì¼">
    <button onclick="signup()">íšŒì›ê°€ì… ìš”ì²­</button>
</div>

<div class="container">
    <h2>2. ë¡œê·¸ì¸</h2>
    <input type="text" id="login-username" placeholder="ì‚¬ìš©ì ì´ë¦„">
    <input type="password" id="login-password" placeholder="ë¹„ë°€ë²ˆí˜¸">
    <button onclick="login()">ë¡œê·¸ì¸ ìš”ì²­</button>
    <div id="token-section" class="hidden">
        <h3>ë°œê¸‰ëœ JWT í† í°:</h3>
        <div id="jwt-token-display"></div>
    </div>
</div>

<div class="container">
    <h2>3. ê²Œì‹œë¬¼ ì‘ì„± (ë¡œê·¸ì¸ í›„ í…ŒìŠ¤íŠ¸)</h2>
    <textarea id="post-content" rows="4" placeholder="ê²Œì‹œë¬¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
    <button onclick="createPost()">ê²Œì‹œë¬¼ ì‘ì„± ìš”ì²­</button>
</div>

<div class="container">
    <h2>4. ì „ì²´ ê²Œì‹œë¬¼ ì¡°íšŒ (ë¡œê·¸ì¸ í›„ í…ŒìŠ¤íŠ¸)</h2>
    <button onclick="getAllPosts()">ê²Œì‹œë¬¼ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <div id="posts-list"></div>
</div>

<script>
    let jwtToken = '';

    async function signup() {
        const username = document.getElementById('signup-username').value;
        const password = document.getElementById('signup-password').value;
        const email = document.getElementById('signup-email').value;

        try {
            const response = await fetch('/api/auth/signup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, email })
            });

            if (!response.ok) {
                const errorData = await response.text();
                try {
                    const jsonError = JSON.parse(errorData);
                    throw new Error(jsonError.message || 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                } catch (e) {
                    throw new Error(errorData || 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }

            alert('íšŒì›ê°€ì… ì„±ê³µ!');
            document.getElementById('login-username').value = username;
        } catch (error) {
            alert(error.message);
        }
    }

    async function login() {
        const username = document.getElementById('login-username').value;
        const password = document.getElementById('login-password').value;

        try {
            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            if (!response.ok) {
                const errorData = await response.text();
                throw new Error(errorData || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
            }

            const token = await response.text();
            jwtToken = token;

            document.getElementById('jwt-token-display').textContent = jwtToken;
            document.getElementById('token-section').classList.remove('hidden');
            alert('ë¡œê·¸ì¸ ì„±ê³µ! JWT í† í°ì´ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.');

        } catch (error) {
            alert(error.message);
        }
    }

    async function createPost() {
        if (!jwtToken) {
            alert('ë¨¼ì € ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”!');
            return;
        }

        const content = document.getElementById('post-content').value;

        try {
            const response = await fetch('/api/posts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + jwtToken
                },
                body: JSON.stringify({ content })
            });

            const resultMessage = await response.text();

            if (!response.ok) {
                throw new Error(resultMessage || 'ê²Œì‹œë¬¼ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }

            alert('ì„œë²„ ì‘ë‹µ: ' + resultMessage);
            document.getElementById('post-content').value = '';
            getAllPosts();

        } catch (error) {
            alert(error.message);
        }
    }

    async function getAllPosts() {
        if (!jwtToken) {
            alert('ë¨¼ì € ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”!');
            return;
        }

        try {
            const response = await fetch('/api/posts', {
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + jwtToken }
            });

            if (!response.ok) throw new Error('ê²Œì‹œë¬¼ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

            const posts = await response.json();
            const postsListDiv = document.getElementById('posts-list');
            postsListDiv.innerHTML = '';

            if (posts.length === 0) {
                postsListDiv.innerHTML = '<p>ì‘ì„±ëœ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            posts.forEach(post => {
                const isLiked = post.isLikedByUser || false;

                const likeBtnClass = isLiked ? 'like-btn liked' : 'like-btn';
                const likeBtnText = isLiked ? 'â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ' : 'ğŸ¤ ì¢‹ì•„ìš”';

                const postDiv = document.createElement('div');
                postDiv.className = 'post-item';
                postDiv.innerHTML = `
                    <p><strong>ì‘ì„±ì:</strong> ${post.username}</p>
                    <p>${post.content}</p>
                    <small>ì‘ì„±ì¼: ${new Date(post.createdAt).toLocaleString()}</small>
                    <br><br>
                    <button class="${likeBtnClass}" onclick="toggleLike(${post.id})">${likeBtnText}</button>
                    <br><br>
                    <button class="update-btn" onclick="updatePost(${post.id})">ìˆ˜ì •</button>
                    <button class="delete-btn" onclick="deletePost(${post.id})">ì‚­ì œ</button>
                `;
                postsListDiv.appendChild(postDiv);
            });

        } catch (error) {
            alert(error.message);
        }
    }

    async function updatePost(postId) {
        if (!jwtToken) {
            alert('ë¨¼ì € ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”!');
            return;
        }

        const newContent = prompt("ìƒˆë¡œìš´ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:");
        if (newContent === null || newContent.trim() === '') {
            return;
        }

        try {
            const response = await fetch(`/api/posts/${postId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + jwtToken
                },
                body: JSON.stringify({ content: newContent })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'ê²Œì‹œë¬¼ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì‘ì„±ìë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }

            alert('ê²Œì‹œë¬¼ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            getAllPosts();
        } catch (error) {
            alert(error.message);
        }
    }

    async function deletePost(postId) {
        if (!jwtToken) {
            alert('ë¨¼ì € ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”!');
            return;
        }

        if (!confirm("ì •ë§ë¡œ ì´ ê²Œì‹œë¬¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            return;
        }

        try {
            const response = await fetch(`/api/posts/${postId}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + jwtToken }
            });

            const resultMessage = await response.text();

            if (!response.ok) {
                throw new Error(resultMessage || 'ê²Œì‹œë¬¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì‘ì„±ìë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }

            alert(resultMessage || 'ê²Œì‹œë¬¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            getAllPosts();
        } catch (error) {
            alert(error.message);
        }
    }

    async function toggleLike(postId) {
        if (!jwtToken) {
            alert('ë¨¼ì € ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”!');
            return;
        }

        try {
            const response = await fetch(`/api/posts/${postId}/like`, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + jwtToken
                }
            });

            const resultText = await response.text();

            if (!response.ok) {
                throw new Error(resultText || 'ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }

            alert(resultText || 'ì¢‹ì•„ìš” ì²˜ë¦¬ ì„±ê³µ!');

            getAllPosts();

        } catch (error) {
            alert(error.message);
        }
    }
</script>

</body>

</html>