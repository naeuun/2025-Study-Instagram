<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Instagram API 테스트</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
        .container { border: 1px solid #ccc; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; }
        input, textarea { width: calc(100% - 22px); padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px 15px; border: none; background-color: #007bff; color: white; border-radius: 4px; cursor: pointer; margin-right: 5px; }
        button:hover { background-color: #0056b3; }
        .update-btn { background-color: #28a745; }
        .update-btn:hover { background-color: #218838; }
        .delete-btn { background-color: #dc3545; }
        .delete-btn:hover { background-color: #c82333; }
        .like-btn { background-color: #ffc107; color: #333; } /* 좋아요 버튼 스타일 추가 */
        .like-btn:hover { background-color: #e0a800; }
        #jwt-token-display { background-color: #f0f0f0; padding: 10px; border-radius: 4px; word-wrap: break-word; margin-top: 10px; }
        .hidden { display: none; }
        #posts-list div.post-item { border-bottom: 1px solid #eee; padding: 10px 0; }
        #posts-list div.post-item:last-child { border-bottom: none; }
    </style>
</head>
<body>

<h1>Instagram 백엔드 API 테스트 페이지</h1>

<div class="container">
    <h2>1. 회원가입</h2>
    <input type="text" id="signup-username" placeholder="사용자 이름">
    <input type="password" id="signup-password" placeholder="비밀번호">
    <input type="email" id="signup-email" placeholder="이메일">
    <button onclick="signup()">회원가입 요청</button>
</div>

<div class="container">
    <h2>2. 로그인</h2>
    <input type="text" id="login-username" placeholder="사용자 이름">
    <input type="password" id="login-password" placeholder="비밀번호">
    <button onclick="login()">로그인 요청</button>
    <div id="token-section" class="hidden">
        <h3>발급된 JWT 토큰:</h3>
        <div id="jwt-token-display"></div>
    </div>
</div>

<div class="container">
    <h2>3. 게시물 작성 (로그인 후 테스트)</h2>
    <textarea id="post-content" rows="4" placeholder="게시물 내용을 입력하세요..."></textarea>
    <button onclick="createPost()">게시물 작성 요청</button>
</div>

<div class="container">
    <h2>4. 전체 게시물 조회 (로그인 후 테스트)</h2>
    <button onclick="getAllPosts()">게시물 불러오기</button>
    <div id="posts-list"></div>
</div>

<div class="container">
    <h2>5. 좋아요 요청 (로그인 후 테스트)</h2>
    <p>게시물 ID: <input type="number" id="like_post_id" value="1" placeholder="좋아요할 게시물 ID"></p>
    <button class="like-btn" onclick="toggleLikeManual()">좋아요/취소 요청 (수동 입력)</button>
    <small style="display: block; margin-top: 10px;">* 아래 게시물 목록의 좋아요 버튼을 사용하면 더 편리합니다.</small>
</div>

<script>
    let jwtToken = '';

    async function signup() {
        const username = document.getElementById('signup-username').value;
        const password = document.getElementById('signup-password').value;
        const email = document.getElementById('signup-email').value;

        try {
            const response = await fetch('/api/auth/signup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, email })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || '회원가입에 실패했습니다.');
            }

            alert('회원가입 성공!');
            document.getElementById('login-username').value = username;
        } catch (error) {
            alert(error.message);
        }
    }

    async function login() {
        const username = document.getElementById('login-username').value;
        const password = document.getElementById('login-password').value;

        try {
            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            if (!response.ok) {
                throw new Error('로그인에 실패했습니다. 아이디 또는 비밀번호를 확인하세요.');
            }

            const token = await response.text();
            jwtToken = token;

            document.getElementById('jwt-token-display').textContent = jwtToken;
            document.getElementById('token-section').classList.remove('hidden');
            alert('로그인 성공! JWT 토큰이 발급되었습니다.');

        } catch (error) {
            alert(error.message);
        }
    }

    async function createPost() {
        if (!jwtToken) {
            alert('먼저 로그인을 해주세요!');
            return;
        }

        const content = document.getElementById('post-content').value;

        try {
            const response = await fetch('/api/posts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + jwtToken
                },
                // error: 필드명 불일치
                body: JSON.stringify({ content: content, imageUrl: 'default-url' })
            });

            const resultMessage = await response.text();

            if (!response.ok) {
                throw new Error(resultMessage || '게시물 작성에 실패했습니다.');
            }

            alert('서버 응답: ' + resultMessage);
            document.getElementById('post-content').value = '';
            getAllPosts();
        } catch (error) {
            alert(error.message);
        }
    }

    async function getAllPosts() {
        if (!jwtToken) {
            alert('먼저 로그인을 해주세요!');
            return;
        }

        try {
            const response = await fetch('/api/posts', {
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + jwtToken }
            });

            if (!response.ok) throw new Error('게시물 조회에 실패했습니다.');

            const posts = await response.json();
            const postsListDiv = document.getElementById('posts-list');
            postsListDiv.innerHTML = '';

            if (posts.length === 0) {
                postsListDiv.innerHTML = '<p>작성된 게시물이 없습니다.</p>';
                return;
            }

            posts.forEach(post => {
                const postDiv = document.createElement('div');
                postDiv.className = 'post-item';
                const isLiked = post.liked;  // 게시물이 좋아요 상태인지 확인

                postDiv.innerHTML = `
                    <p><strong>ID: ${post.id}</strong> | <strong>작성자:</strong> ${post.username}</p>
                    <p>${post.content}</p>
                    <small>작성일: ${new Date(post.createdAt).toLocaleString()}</small>
                    <br><br>
                    <button class="update-btn" onclick="updatePost(${post.id})">수정</button>
                    <button class="delete-btn" onclick="deletePost(${post.id})">삭제</button>
                    <button class="like-btn" onclick="toggleLike(${post.id})">${isLiked ? '좋아요 취소' : '좋아요'}</button>
                `;
                postsListDiv.appendChild(postDiv);
            });

        } catch (error) {
            alert(error.message);
        }
    }

    async function toggleLike(postId) {
        if (!jwtToken) {
            alert('먼저 로그인을 해주세요!');
            return;
        }

        try {
            const response = await fetch(`/api/posts/${postId}/like`, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + jwtToken
                }
            });

            if (!response.ok) {
                throw new Error('좋아요/좋아요 취소 요청에 실패했습니다.');
            }

            getAllPosts();  // 게시물 목록을 새로고침하여 좋아요 상태 업데이트
            alert('좋아요/좋아요 취소가 성공적으로 처리되었습니다.');
        } catch (error) {
            alert(error.message);
        }
    }

    async function toggleLikeManual() {
        const postId = document.getElementById('like_post_id').value;
        if (!postId) {
            alert('게시물 ID를 입력하세요.');
            return;
        }
        const success = await sendLikeRequest(postId);

        if (success) {
            getAllPosts();
        }
    }

    // 좋아요 API
    async function sendLikeRequest(postId) {
        if (!jwtToken) {
            alert('먼저 로그인을 해주세요!');
            return;
        }

        try {
            const response = await fetch(`/api/posts/${postId}/like`, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + jwtToken
                }
            });

            const resultMessage = await response.text();

            if (response.ok) {
                alert(`좋아요 요청 성공`);
            } else if (response.status === 401) {
                alert("좋아요 요청 실패 (401 jwt 토큰 오류)");
            } else {
                alert(`좋아요 요청 실패 (기타 오류)`);
            }
        } catch (error) {
            console.error('API 요청 오류', error);
            alert('네트워크 요청 오류');
        }
    }
</script>

</body>
</html>